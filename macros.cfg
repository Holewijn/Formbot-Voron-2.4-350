#####################################################################
#   Macros
#####################################################################

[gcode_macro G32]
gcode:
    SAVE_GCODE_STATE NAME=STATE_G32
    G90
    G28
    QUAD_GANTRY_LEVEL
    G28

    G0 X150 Y150 Z60 F3600
    
    RESTORE_GCODE_STATE NAME=STATE_G32

[gcode_macro PRINT_START]
gcode:
  # Parameters
  {% set bedtemp = params.BED|int %}
  {% set hotendtemp = params.EXTRUDER|int %}
  {% set nozzle = params.NOZZLE|default(0.4)|float %}
  {% set target_chamber = params.CHAMBER|default("45")|int %}
  {% set target_chamber_minimal = params.CHAMBER_MINIMAL|default("0")|int %}
  {% set target_chamber_wait = [target_chamber, target_chamber_minimal]|select(">", 0)|min|default(0) %}
  {% set x_wait = printer.toolhead.axis_maximum.x|float / 2 %}
  {% set y_wait = printer.toolhead.axis_maximum.y|float / 2 %}

  VALIDATE_NOZZLE NOZZLE={nozzle}
  # Clear any lingering pause states
  CLEAR_PAUSE

  # Home the printer, set absolute positioning and update the Stealthburner LEDs.
  STATUS_HOMING                                         # Set LEDs to homing-mode
  G28                                                   # Full home (XYZ)
  G90                                                   # Absolute position

  #  Uncomment for bed mesh (1 of 2 for bed mesh)
  BED_MESH_CLEAR                                       # Clear old saved bed mesh (if any)

  # Check if the bed temp is higher than 90c - if so then trigger a heatsoak.
  {% if params.BED|int > 90 %}
    SET_DISPLAY_TEXT MSG="Bed: {bedtemp}c"           # Display info on display
    STATUS_HEATING                                      # Set LEDs to heating-mode
    M106 S255                                           # Turn on the PT-fan

    ##  Uncomment if you have a Nevermore.
    #SET_PIN PIN=nevermore VALUE=1                      # Turn on the nevermore

    G1 X{x_wait} Y{y_wait} Z15 F9000                    # Go to center of the bed
    M190 S{bedtemp}                                  # Set the target temp for the bed
    SET_DISPLAY_TEXT MSG="Heatsoak: {target_chamber_wait}c"  # Display info on display
    TEMPERATURE_WAIT SENSOR="temperature_sensor chamber" MINIMUM={target_chamber_wait}   # Waits for chamber temp

  # If the bed temp is not over 90c, then skip the heatsoak and just heat up to set temp with a 5 min soak
  {% else %}
    SET_DISPLAY_TEXT MSG="Bed: {bedtemp}c"           # Display info on display
    STATUS_HEATING                                      # Set LEDs to heating-mode
    G1 X{x_wait} Y{y_wait} Z15 F9000                    # Go to center of the bed
    M190 S{bedtemp}                                  # Set the target temp for the bed
    SET_DISPLAY_TEXT MSG="Soak for 5 min"               # Display info on display
    G4 P3000                                         # Wait 5 min for the bedtemp to stabilize
    # G4 P300000                                          # Wait 5 min for the bedtemp to stabilize
  {% endif %}

  # Heat hotend to 150c. This helps with getting a correct Z-home.
  SET_DISPLAY_TEXT MSG="Hotend: 150c"                   # Display info on display
  M109 S150                                             # Heat hotend to 150c

  ##  Uncomment for V2.4 (Quad gantry level AKA QGL)
  SET_DISPLAY_TEXT MSG="Leveling"                      # Display info on display
  STATUS_LEVELING                                      # Set LEDs to leveling-mode
  QUAD_GANTRY_LEVEL                                    # Level the printer via QGL
  G28 Z                                                # Home Z again after QGL

  ##  Uncomment for bed mesh (2 of 2 for bed mesh)
  SET_DISPLAY_TEXT MSG="Bed mesh"                      # Display info on display
  STATUS_MESHING                                       # Set LEDs to bed mesh-mode
  BED_MESH_CALIBRATE ADAPTIVE=1                                  # Start the bed mesh (add ADAPTIVE=1) for adaptive bed mesh

  ## Uncomment for Beacon Contact (3 of 4 for beacon contact)
  #G28 Z METHOD=CONTACT CALIBRATE=0                     # Calibrate z offset only with hot nozzle

  # Heat up the hotend up to target via data from slicer
  SET_DISPLAY_TEXT MSG="Hotend: {hotendtemp}c"     # Display info on display
  STATUS_HEATING                                        # Set LEDs to heating-mode
  G1 X{x_wait} Y{y_wait} Z15 F9000                      # Go to center of the bed
  M107                                                  # Turn off partcooling fan
  M109 S{hotendtemp}                               # Heat the hotend to set temp

  ##   Uncomment for Beacon Contact (4 of 4 for beacon contact)
  #SET_GCODE_OFFSET Z=0.06                              # Add a little offset for hotend thermal expansion

  # Get ready to print by doing a primeline and updating the LEDs
  SET_DISPLAY_TEXT MSG="Printer goes brr"               # Display info on display
  STATUS_PRINTING                                       # Set LEDs to printing-mode
  G0 X{x_wait - 50} Y4 F10000                           # Go to starting point
  G0 Z0.4                                               # Raise Z to 0.4
  G91                                                   # Incremental positioning 
  G1 X100 E20 F1000                                     # Primeline
  G90                                                   # Absolute position


#   Use PRINT_END for the slicer ending script - please customise for your slicer of choice
[gcode_macro PRINT_END]
gcode:
    # safe anti-stringing move coords
    {% set th = printer.toolhead %}
    {% set x_safe = th.position.x + 20 * (1 if th.axis_maximum.x - th.position.x > 20 else -1) %}
    {% set y_safe = th.position.y + 20 * (1 if th.axis_maximum.y - th.position.y > 20 else -1) %}
    {% set z_safe = [th.position.z + 2, th.axis_maximum.z]|min %}
    
    SAVE_GCODE_STATE NAME=STATE_PRINT_END
    
    M400                           ; wait for buffer to clear
    G92 E0                         ; zero the extruder
    G1 E-5.0 F1800                 ; retract filament
    
    TURN_OFF_HEATERS
    
    G90                                      ; absolute positioning
    G0 X{x_safe} Y{y_safe} Z{z_safe} F20000  ; move nozzle to remove stringing
    G0 X{th.axis_maximum.x//2} Y{th.axis_maximum.y - 2} F3600  ; park nozzle at rear
    M107                                     ; turn off fan
    
    BED_MESH_CLEAR
    BED_MESH_PROFILE REMOVE=default
    RESTORE_GCODE_STATE NAME=STATE_PRINT_END

    
### HIER ONDER OUDE CONFIG! 

# [gcode_macro CHAMBER_MODE]
# description: Set chamber/exhaust/nevermore/bed_fans behavior by material
# gcode:
#   {% set mat = params.MATERIAL|default("PLA")|upper %}

#   # defaults (PLA/PETG-ish)
#   SET_TEMPERATURE_FAN_TARGET FAN=exhaust_fan TARGET=35
#   FILTER_ON
#   SET_FAN_SPEED FAN=bed_fans SPEED=0

#   {% if mat in ["ABS", "ASA"] %}
#     # warm chamber allowed, bed fans helpen opwarmen
#     SET_TEMPERATURE_FAN_TARGET FAN=exhaust_fan TARGET=55
#     FILTER_ON
#     SET_FAN_SPEED FAN=bed_fans SPEED=1.0

#   {% elif mat in ["NYLON", "PA", "PA6", "PA12"] %}
#     SET_TEMPERATURE_FAN_TARGET FAN=exhaust_fan TARGET=60
#     FILTER_ON
#     SET_FAN_SPEED FAN=bed_fans SPEED=1.0

#   {% elif mat in ["PETG"] %}
#     SET_TEMPERATURE_FAN_TARGET FAN=exhaust_fan TARGET=40
#     FILTER_ON
#     SET_FAN_SPEED FAN=bed_fans SPEED=0

#   {% else %}
#     # PLA en alles onbekend
#     SET_TEMPERATURE_FAN_TARGET FAN=exhaust_fan TARGET=35
#     FILTER_ON
#     SET_FAN_SPEED FAN=bed_fans SPEED=0
#   {% endif %}

# [delayed_gcode after_startup_1]
# initial_duration: 1.
# gcode:
#   LIGHT_PENDING
  
# [delayed_gcode after_startup_2]
# initial_duration: 5.
# gcode:
#   LIGHT_OFF

# [gcode_macro G32]
# gcode:
#     BED_MESH_CLEAR
#     G28
#     QUAD_GANTRY_LEVEL
#     G28

# [gcode_macro FILTER_ON]
# gcode:
#     SET_FAN_SPEED FAN=Nevermore SPEED=1.0

# [gcode_macro FILTER_OFF]
# gcode:
#     SET_FAN_SPEED FAN=Nevermore SPEED=0

# [gcode_macro _CHAMBER_BY_FILAMENT]
# variable_target: 35
# gcode:
#   {% set mat = params.FILAMENT|default("PLA")|upper %}

#   # Defaults (PLA/unknown)
#   {% set target = 35 %}
#   {% set bedfan = 0.0 %}
#   {% set filter_speed = 0.3 %}

#   {% if mat in ["PETG"] %}
#     {% set target = 40 %}
#     {% set bedfan = 0.0 %}
#     {% set filter_speed = 0.5 %}

#   {% elif mat in ["ABS","ASA"] %}
#     {% set target = 55 %}
#     {% set bedfan = 1.0 %}
#     {% set filter_speed = 1.0 %}

#   {% elif mat in ["NYLON","PA","PA6","PA12"] %}
#     {% set target = 60 %}
#     {% set bedfan = 1.0 %}
#     {% set filter_speed = 1.0 %}
#   {% endif %}

#   # Apply exhaust target (temperature_fan)
#   SET_TEMPERATURE_FAN_TARGET TEMPERATURE_FAN=exhaust_fan TARGET={target}

#   # Nevermore on (jij hebt FILTER_ON/OFF)
#   FILTER_ON
#   # Als je FILTER_ON altijd op 100% zet en je wil hier variÃ«ren:
#   # maak FILTER_ON een macro met parameter, of laat dit stukje weg.

#   # Bed fans for fast chamber warmup
#   SET_FAN_SPEED FAN=bed_fans SPEED={bedfan}

#   # Save target so delayed checker knows when to stop bed fans
#   SET_GCODE_VARIABLE MACRO=_CHAMBER_BY_FILAMENT VARIABLE=target VALUE={target}

#   # Start/stop the delayed auto-off loop
#   {% if bedfan > 0 %}
#     UPDATE_DELAYED_GCODE ID=_BEDFAN_AUTOOFF DURATION=5
#   {% else %}
#     UPDATE_DELAYED_GCODE ID=_BEDFAN_AUTOOFF DURATION=0
#   {% endif %}

# [delayed_gcode _BEDFAN_AUTOOFF]
# gcode:
#   {% set target = printer["gcode_macro _CHAMBER_BY_FILAMENT"].target|float %}
#   {% set chamber = printer["temperature_fan exhaust_fan"].temperature|float %}

#   # Stop bed fans when chamber is close to target
#   {% if chamber >= (target - 2.0) %}
#     SET_FAN_SPEED FAN=bed_fans SPEED=0
#   {% else %}
#     UPDATE_DELAYED_GCODE ID=_BEDFAN_AUTOOFF DURATION=10
#   {% endif %}
  

# #####################################################################
# #   A better print_start macro for v2/trident
# #####################################################################

# ## *** THINGS TO UNCOMMENT: ***
# ## Bed mesh (2 lines at 2 locations)
# ## Nevermore (if you have one)
# ## Z_TILT_ADJUST (For Trident only)
# ## QUAD_GANTRY_LEVEL (For V2.4 only)
# ## Beacon Contact logic (if you have one. 4 lines at 4 locations)

# [gcode_macro PRINT_START]
# gcode:
#   # This part fetches data from your slicer. Such as bed, extruder, and chamber temps and size of your printer.
#   {% set bedtemp = params.BED|int %}
#   {% set hotendtemp = params.EXTRUDER|int %}
#   {% set target_chamber = params.CHAMBER|default("45")|int %}
#   {% set target_chamber_minimal = params.CHAMBER_MINIMAL|default("0")|int %}
#   {% set target_chamber_wait = [target_chamber, target_chamber_minimal]|select(">", 0)|min|default(0) %}
#   {% set x_wait = printer.toolhead.axis_maximum.x|float / 2 %}
#   {% set y_wait = printer.toolhead.axis_maximum.y|float / 2 %}

#   # Clear any lingering pause states
#   CLEAR_PAUSE

#   # Home the printer, set absolute positioning and update the Stealthburner LEDs.
#   STATUS_HOMING                                         # Set LEDs to homing-mode
#   G28                                                   # Full home (XYZ)
#   G90                                                   # Absolute position

#   #  Uncomment for bed mesh (1 of 2 for bed mesh)
#   BED_MESH_CLEAR                                       # Clear old saved bed mesh (if any)

#   # Check if the bed temp is higher than 90c - if so then trigger a heatsoak.
#   {% if params.BED|int > 90 %}
#     SET_DISPLAY_TEXT MSG="Bed: {bedtemp}c"           # Display info on display
#     STATUS_HEATING                                      # Set LEDs to heating-mode
#     M106 S255                                           # Turn on the PT-fan

#     ##  Uncomment if you have a Nevermore.
#     #SET_PIN PIN=nevermore VALUE=1                      # Turn on the nevermore

#     G1 X{x_wait} Y{y_wait} Z15 F9000                    # Go to center of the bed
#     M190 S{bedtemp}                                  # Set the target temp for the bed
#     SET_DISPLAY_TEXT MSG="Heatsoak: {target_chamber_wait}c"  # Display info on display
#     TEMPERATURE_WAIT SENSOR="temperature_sensor chamber" MINIMUM={target_chamber_wait}   # Waits for chamber temp

#   # If the bed temp is not over 90c, then skip the heatsoak and just heat up to set temp with a 5 min soak
#   {% else %}
#     SET_DISPLAY_TEXT MSG="Bed: {bedtemp}c"           # Display info on display
#     STATUS_HEATING                                      # Set LEDs to heating-mode
#     G1 X{x_wait} Y{y_wait} Z15 F9000                    # Go to center of the bed
#     M190 S{bedtemp}                                  # Set the target temp for the bed
#     SET_DISPLAY_TEXT MSG="Soak for 5 min"               # Display info on display
#     G4 P3000                                         # Wait 5 min for the bedtemp to stabilize
#     # G4 P300000                                          # Wait 5 min for the bedtemp to stabilize
#   {% endif %}

#   # Heat hotend to 150c. This helps with getting a correct Z-home.
#   SET_DISPLAY_TEXT MSG="Hotend: 150c"                   # Display info on display
#   M109 S150                                             # Heat hotend to 150c

#   ##  Uncomment for V2.4 (Quad gantry level AKA QGL)
#   SET_DISPLAY_TEXT MSG="Leveling"                      # Display info on display
#   STATUS_LEVELING                                      # Set LEDs to leveling-mode
#   QUAD_GANTRY_LEVEL                                    # Level the printer via QGL
#   G28 Z                                                # Home Z again after QGL

#   ##  Uncomment for bed mesh (2 of 2 for bed mesh)
#   SET_DISPLAY_TEXT MSG="Bed mesh"                      # Display info on display
#   STATUS_MESHING                                       # Set LEDs to bed mesh-mode
#   BED_MESH_CALIBRATE ADAPTIVE=1                                  # Start the bed mesh (add ADAPTIVE=1) for adaptive bed mesh

#   ## Uncomment for Beacon Contact (3 of 4 for beacon contact)
#   #G28 Z METHOD=CONTACT CALIBRATE=0                     # Calibrate z offset only with hot nozzle

#   # Heat up the hotend up to target via data from slicer
#   SET_DISPLAY_TEXT MSG="Hotend: {hotendtemp}c"     # Display info on display
#   STATUS_HEATING                                        # Set LEDs to heating-mode
#   G1 X{x_wait} Y{y_wait} Z15 F9000                      # Go to center of the bed
#   M107                                                  # Turn off partcooling fan
#   M109 S{hotendtemp}                               # Heat the hotend to set temp

#   ##   Uncomment for Beacon Contact (4 of 4 for beacon contact)
#   #SET_GCODE_OFFSET Z=0.06                              # Add a little offset for hotend thermal expansion

#   # Get ready to print by doing a primeline and updating the LEDs
#   SET_DISPLAY_TEXT MSG="Printer goes brr"               # Display info on display
#   STATUS_PRINTING                                       # Set LEDs to printing-mode
#   G0 X{x_wait - 50} Y4 F10000                           # Go to starting point
#   G0 Z0.4                                               # Raise Z to 0.4
#   G91                                                   # Incremental positioning 
#   G1 X100 E20 F1000                                     # Primeline
#   G90                                                   # Absolute position
 
   

# ##################################################
# # PRINT_END                                      #
# ##################################################
# [gcode_macro PRINT_END]
# description: Called by the slicer before the print finished
# gcode:
#     {% set X_SAFE = printer.toolhead.position.x + 20 * (1 if printer.toolhead.axis_maximum.x - printer.toolhead.position.x > 20 else -1) %}
#     {% set Y_SAFE = printer.toolhead.position.y + 20 * (1 if printer.toolhead.axis_maximum.y - printer.toolhead.position.y > 20 else -1) %}
#     {% set Z_SAFE = [printer.toolhead.position.z + 2, printer.toolhead.axis_maximum.z]|min %}
#     {% set X_WAIT = printer.toolhead.axis_maximum.x|float - 20 %}
#     {% set Y_WAIT = printer.toolhead.axis_maximum.y|float - 5 %}
#     {% set Z_WAIT = printer.toolhead.axis_maximum.z if printer.toolhead.position.z > (printer.toolhead.axis_maximum.z - 15) else printer.toolhead.axis_maximum.z - 15 %}
#     {% set DEFAULT_VELOCITY = printer.configfile.settings.printer.max_velocity|float %}
#     {% set DEFAULT_ACCEL = printer.configfile.settings.printer.max_accel|float %}
#     {% set DEFAULT_MINIMUM_CRUISE_RATIO = printer.configfile.settings.printer.minimum_cruise_ratio|float %}
#     {% set DEFAULT_SQUARE_CORNER_VELOCITY = printer.configfile.settings.printer.square_corner_velocity|float %}

#     SET_DISPLAY_TEXT MSG="Finishing..."
#     STATUS_BUSY

#     # Wait for buffer to clear
#     M400
#     # Zero the extruder and retract 10 mm
#     G92 E0
#     G1 E-10.0 F1800
    
#     # Turn of heaters
#     TURN_OFF_HEATERS

#     # Move nozzle to remove stringing and park toolhead
#     G90
#     G0 X{X_SAFE} Y{Y_SAFE} Z{Z_SAFE} F20000
#     G0 X{X_WAIT} Y{Y_WAIT} Z{Z_WAIT} F6000

#     # Reset changes as speed, flow, fans, ...
#     M220 S100	                                          ; set print speed to 100%
#     M221 S100	                                          ; set flow rate to 100%
#     M107                                                  ; disable fans
#     M107 P2                                               ; disable fans
#     BED_MESH_CLEAR                                        ; clear bed mesh
#     SET_SKEW CLEAR=1                                      ; reset skew
#     SET_GCODE_OFFSET Z=0                                  ; reset z offset
#     CLEAR_PAUSE                                           ; clear pause state
#     SFS_DISABLE                                           ; disable filament sensor

#     # Resetting velocity limits
#     SET_VELOCITY_LIMIT VELOCITY={DEFAULT_VELOCITY} ACCEL={DEFAULT_ACCEL} MINIMUM_CRUISE_RATIO={DEFAULT_MINIMUM_CRUISE_RATIO} SQUARE_CORNER_VELOCITY={DEFAULT_SQUARE_CORNER_VELOCITY}

#     # Turn the filter off after 10 minutes
#     {% if printer['fan_generic exhaust_fan'].speed > 0 %}
#         UPDATE_DELAYED_GCODE ID=FILTER_OFF_DELAYED DURATION=600
#     {% endif %}

#     SET_DISPLAY_TEXT
#     STATUS_READY
#     LIGHT_OFF



# [gcode_macro LIGHT_PENDING]
# gcode:
#   SET_LED LED=Top_Hat_LEDs RED=1 GREEN=0.02 BLUE=0.02 WHITE=0 INDEX=1 TRANSMIT=0
#   SET_LED LED=Top_Hat_LEDs RED=0 GREEN=0 BLUE=0 WHITE=0 INDEX=2 TRANSMIT=0
#   SET_LED LED=Top_Hat_LEDs RED=0 GREEN=0 BLUE=0 WHITE=0 INDEX=3 TRANSMIT=1
#   #SET_PIN PIN=Top_Hat_LEDs VALUE=0

# [gcode_macro LIGHT_PRINTING]
# gcode:
#   SET_LED LED=Top_Hat_LEDs RED=0 GREEN=0.0 BLUE=0.0 WHITE=0.5
#   #SET_PIN PIN=Top_Hat_LEDs VALUE=0.8

# [gcode_macro LIGHT_OFF]
# gcode:
#   SET_LED LED=Top_Hat_LEDs RED=0 GREEN=0.02 BLUE=0 WHITE=0 INDEX=1 TRANSMIT=0
#   SET_LED LED=Top_Hat_LEDs RED=0 GREEN=0 BLUE=0 WHITE=0 INDEX=2 TRANSMIT=0
#   SET_LED LED=Top_Hat_LEDs RED=0 GREEN=0 BLUE=0 WHITE=0 INDEX=3 TRANSMIT=1
#   #SET_PIN PIN=Top_Hat_LEDs VALUE=0

# [gcode_macro NOZZLE_PRIME_AND_BRUSH]
# gcode:
#    {% set EXTRUDER_TEMP = params.EXTRUDER_TEMP|default(190)|float %}

#   # Move over bucker
#   G0 X298 Y303 Z10 F9000

#   # Purge
#   M104 S{EXTRUDER_TEMP}
#   TEMPERATURE_WAIT sensor=extruder MINIMUM={EXTRUDER_TEMP-5} MAXIMUM={EXTRUDER_TEMP+5}
#   M83  
#   G1 E50 F500
#   G1 E-5  F500
#   M104 S150

#   # Brush
#   {% for i in range(10) %}
#     G0 X238 Y299 F5000
#     G0 X278 Y302 F5000
#   {% endfor %}

#   G0 Y290 F3000

# [gcode_macro NOZZLE_PURGE]
# description: Draw a purge line at the front left edge of the build plate
# gcode:
#   CHOME
#   G0 X2.5 Y2 F6000 ; Go to front
#   G0 Z0.2 ; Drop to bed
#   M83 ; Set extruder to relative mode
#   G1 X25 E10 F500 ; Extrude 25mm of filament in a 4cm line
#   G1 X50 F5000 ; Quickly wipe away from the filament line
#   G1 X75 E2.00 F1500
#   G1 E-0.1 F400 ; Retract a little
#   G1 Z0.5 ; Raise and begin printing.

# [gcode_macro CHOME]
# description: Homes XYZ axis only if printer is in a non-homed state
# gcode:
#   {% if "xyz" not in printer.toolhead.homed_axes or printer["quad_gantry_level"].applied == false %}
#     G32
#   {% endif %}

# [gcode_macro TEST_SPEED]
# # Home, get position, throw around toolhead, home again.
# # If MCU stepper positions (first line in GET_POSITION) are greater than a full step different (your number of microsteps), then skipping occured.
# # We only measure to a full step to accomodate for endstop variance.
# # Example: TEST_SPEED SPEED=300 ACCEL=5000 ITERATIONS=10

# description: Test for max speed and acceleration parameters for the printer. Procedure: Home -> ReadPositionFromMCU -> MovesToolhead@Vel&Accel -> Home -> ReadPositionfromMCU

# gcode:
#     # Speed
#     {% set speed  = params.SPEED|default(printer.configfile.settings.printer.max_velocity)|int %}
#     # Iterations
#     {% set iterations = params.ITERATIONS|default(5)|int %}
#     # Acceleration
#     {% set accel  = params.ACCEL|default(printer.configfile.settings.printer.max_accel)|int %}
#     # Minimum Cruise Ratio
#     {% set min_cruise_ratio = params.MIN_CRUISE_RATIO|default(0.5)|float %}
#     # Bounding inset for large pattern (helps prevent slamming the toolhead into the sides after small skips, and helps to account for machines with imperfectly set dimensions)
#     {% set bound = params.BOUND|default(20)|int %}
#     # Size for small pattern box
#     {% set smallpatternsize = SMALLPATTERNSIZE|default(20)|int %}
    
#     # Large pattern
#         # Max positions, inset by BOUND
#         {% set x_min = printer.toolhead.axis_minimum.x %}
#         {% if x_min < 0 %}
#             {% set x_min = 0 %}
#         {% endif %}
    
#         {% set y_min = printer.toolhead.axis_minimum.y %}
#         {% if y_min < 0 %}
#             {% set y_min = 0 %}
#         {% endif %}
    
#         {% set x_min = x_min + bound %}
#         {% set x_max = printer.toolhead.axis_maximum.x - bound %}
#         {% set y_min = y_min + bound %}
#         {% set y_max = printer.toolhead.axis_maximum.y - bound %}
    
#     # Small pattern at center
#         # Find X/Y center point
#         {% set x_center = (printer.toolhead.axis_minimum.x|float + printer.toolhead.axis_maximum.x|float ) / 2 %}
#         {% set y_center = (printer.toolhead.axis_minimum.y|float + printer.toolhead.axis_maximum.y|float ) / 2 %}
        
#         # Set small pattern box around center point
#         {% set x_center_min = x_center - (smallpatternsize/2) %}
#         {% set x_center_max = x_center + (smallpatternsize/2) %}
#         {% set y_center_min = y_center - (smallpatternsize/2) %}
#         {% set y_center_max = y_center + (smallpatternsize/2) %}

#     # Save current gcode state (absolute/relative, etc)
#     SAVE_GCODE_STATE NAME=TEST_SPEED
    
#     # Output parameters to g-code terminal
#     { action_respond_info("TEST_SPEED: starting %d iterations at speed %d, accel %d" % (iterations, speed, accel)) }
    
#     # Home and get position for comparison later:
#         M400 # Finish moves - https://github.com/AndrewEllis93/Print-Tuning-Guide/issues/66
#         G28
#         # QGL if not already QGLd (only if QGL section exists in config)
#         {% if printer.configfile.settings.quad_gantry_level %}
#             {% if printer.quad_gantry_level.applied == False %}
#                 QUAD_GANTRY_LEVEL
#                 G28 Z
#             {% endif %}
#         {% endif %} 
#         # Move 50mm away from max position and home again (to help with hall effect endstop accuracy - https://github.com/AndrewEllis93/Print-Tuning-Guide/issues/24)
#         G90
#         G1 X{printer.toolhead.axis_maximum.x-50} Y{printer.toolhead.axis_maximum.y-50} F{30*60}
#         M400 # Finish moves - https://github.com/AndrewEllis93/Print-Tuning-Guide/issues/66
#         G28 X Y
#         G0 X{printer.toolhead.axis_maximum.x-1} Y{printer.toolhead.axis_maximum.y-1} F{30*60}
#         G4 P1000 
#         GET_POSITION

#     # Go to starting position
#     G0 X{x_min} Y{y_min} Z{bound + 10} F{speed*60}

#     # Set new limits
#     {% if printer.configfile.settings.printer.minimum_cruise_ratio is defined %}
#         SET_VELOCITY_LIMIT VELOCITY={speed} ACCEL={accel} MINIMUM_CRUISE_RATIO={min_cruise_ratio}
#     {% else %}
#         SET_VELOCITY_LIMIT VELOCITY={speed} ACCEL={accel} ACCEL_TO_DECEL={accel / 2}
#     {% endif %}

#     {% for i in range(iterations) %}
#         # Large pattern diagonals
#         G0 X{x_min} Y{y_min} F{speed*60}
#         G0 X{x_max} Y{y_max} F{speed*60}
#         G0 X{x_min} Y{y_min} F{speed*60}
#         G0 X{x_max} Y{y_min} F{speed*60}
#         G0 X{x_min} Y{y_max} F{speed*60}
#         G0 X{x_max} Y{y_min} F{speed*60}
        
#         # Large pattern box
#         G0 X{x_min} Y{y_min} F{speed*60}
#         G0 X{x_min} Y{y_max} F{speed*60}
#         G0 X{x_max} Y{y_max} F{speed*60}
#         G0 X{x_max} Y{y_min} F{speed*60}
    
#         # Small pattern diagonals
#         G0 X{x_center_min} Y{y_center_min} F{speed*60}
#         G0 X{x_center_max} Y{y_center_max} F{speed*60}
#         G0 X{x_center_min} Y{y_center_min} F{speed*60}
#         G0 X{x_center_max} Y{y_center_min} F{speed*60}
#         G0 X{x_center_min} Y{y_center_max} F{speed*60}
#         G0 X{x_center_max} Y{y_center_min} F{speed*60}
        
#         # Small pattern box
#         G0 X{x_center_min} Y{y_center_min} F{speed*60}
#         G0 X{x_center_min} Y{y_center_max} F{speed*60}
#         G0 X{x_center_max} Y{y_center_max} F{speed*60}
#         G0 X{x_center_max} Y{y_center_min} F{speed*60}
#     {% endfor %}

#     # Restore max speed/accel/accel_to_decel to their configured values
#     {% if printer.configfile.settings.printer.minimum_cruise_ratio is defined %}
#         SET_VELOCITY_LIMIT VELOCITY={printer.configfile.settings.printer.max_velocity} ACCEL={printer.configfile.settings.printer.max_accel} MINIMUM_CRUISE_RATIO={printer.configfile.settings.printer.minimum_cruise_ratio} 
#     {% else %}
#         SET_VELOCITY_LIMIT VELOCITY={printer.configfile.settings.printer.max_velocity} ACCEL={printer.configfile.settings.printer.max_accel} ACCEL_TO_DECEL={printer.configfile.settings.printer.max_accel_to_decel}
#     {% endif %}

#     # Re-home and get position again for comparison:
#         M400 # Finish moves - https://github.com/AndrewEllis93/Print-Tuning-Guide/issues/66
#         G28 # This is a full G28 to fix an issue with CoreXZ - https://github.com/AndrewEllis93/Print-Tuning-Guide/issues/12
#         # Go to XY home positions (in case your homing override leaves it elsewhere)
#         G90
#         G0 X{printer.toolhead.axis_maximum.x-1} Y{printer.toolhead.axis_maximum.y-1} F{30*60}
#         G4 P1000 
#         GET_POSITION

#     # Restore previous gcode state (absolute/relative, etc)
#     RESTORE_GCODE_STATE NAME=TEST_SPEED
    