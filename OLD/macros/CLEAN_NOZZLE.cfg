# ==========================================================
# ðŸ§¼ NOZZLE CLEANING ROUTINE
# ==========================================================
[gcode_macro CLEAN_NOZZLE]
description: "Move nozzle to brush and clean"
gcode:
  G90
  G1 Z10 F600
  G1 X267 Y350 F6000
  G1 Z5.4 F600
  {% for i in range(3) %}
    G1 X297 F4000
    G1 X267 F4000
  {% endfor %}
  G1 Z10 F600

# ==========================================================
# ðŸª£ PURGE INTO BUCKET (right of the brush @ Y=350)
# ==========================================================
[gcode_macro PURGE_BUCKET]
description: "Purge filament into a bucket right of the brush"
# Defaults â€” tweak once to match your bucket opening
variable_bucket_x: 315.0          # bucket center X (right of X297 brush edge)
variable_bucket_y: 350.0          # same Y row as your brush
variable_purge_z: 4.0             # nozzle Z inside the bucket
variable_purge_len: 30.0          # mm of filament to purge
variable_purge_rate: 3.0          # mm/s of filament
variable_retract_after: 1.5       # mm retract to cut string
variable_wiggle: 1                # 1=wiggle to snap string
variable_wiggle_amp: 2.0          # mm
variable_wiggle_reps: 6
# Safety / motion
variable_clearance: 30.0          # lift above current Z before XY travel
variable_z_margin: 5.0            # keep below Z max by this margin
variable_travel_f: 6000           # mm/min
variable_z_f: 600                 # mm/min

gcode:
  {% if 'xyz' not in printer.toolhead.homed_axes %}
    G28
  {% endif %}

  # Compute a safe Z
  {% set z_now = printer.toolhead.position.z|float %}
  {% set z_max = printer.toolhead.axis_maximum.z|float %}
  {% set safe_z = [z_now + clearance, z_max - z_margin]|min %}

  # Params or defaults
  {% set bx = params.X|default(bucket_x)|float %}
  {% set by = bucket_y|float %}
  {% set pz = params.Z|default(purge_z)|float %}
  {% set purge_len = params.LEN|default(purge_len)|float %}
  {% set purge_rate = params.RATE|default(purge_rate)|float %}
  {% set wiggle = (params.WIGGLE|default(wiggle)|int) == 1 %}
  {% set wamp = params.AMP|default(wiggle_amp)|float %}
  {% set wreps = params.REPS|default(wiggle_reps)|int %}
  {% set retract_after = params.RETRACT|default(retract_after)|float %}
  {% set travel_f = params.TRAVEL_F|default(travel_f)|int %}
  {% set z_f = params.Z_F|default(z_f)|int %}

  {% set min_temp = printer.configfile.settings.extruder.min_extrude_temp|default(170)|float %}

  # Always move safely to the bucket row, but only EXTRUDE if hot enough
  G90
  G1 Z{safe_z} F{z_f}
  G1 X{bx} F{travel_f}
  G1 Y{by} F{travel_f}
  G1 Z{pz} F{z_f}

  {% if printer.extruder.temperature < min_temp %}
    {action_respond_info(
      "Skipping purge: hotend %.1fÂ°C < min_extrude_temp %.1fÂ°C (positioned over bucket only)"
      % (printer.extruder.temperature, min_temp)
    )}
  {% else %}
    SAVE_GCODE_STATE NAME=PURGE_BUCKET_STATE
    M83
    G1 E{purge_len} F{(purge_rate*60)|int}
    {% if wiggle and wreps > 0 %}
      {% for i in range(wreps) %}
        G1 X{bx + (wamp if (i % 2)==0 else -wamp)} F{travel_f}
      {% endfor %}
      G1 X{bx} F{travel_f}
    {% endif %}
    G1 E-{retract_after} F{(30*60)}
    M82
    RESTORE_GCODE_STATE NAME=PURGE_BUCKET_STATE MOVE=0
  {% endif %}

  # Lift out safely regardless
  G1 Z{safe_z} F{z_f}
