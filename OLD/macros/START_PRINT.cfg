[gcode_macro START_PRINT]
description: "Start print: safe warmup, detect filament from filename, KAMP fallback"
gcode:
  # --- Detect filament from filename (robust) ---
  {% set raw  = (printer.print_stats.filename or "") %}
  {% set name = raw|lower
                  |replace("\u00a0"," ")
                  |replace("_"," ")
                  |replace("-"," ")
                  |replace(".gcode","")
                  |trim %}
  {% set f = "PLA" %}
  {% set b = 60 %}
  {% set e = 200 %}
  {% set c = 0 %}
  {% if "abs" in name %}
    {% set f = "ABS" %}{% set b = 115 %}{% set e = 250 %}{% set c = 50 %}
  {% elif "asa" in name %}
    {% set f = "ASA" %}{% set b = 115 %}{% set e = 255 %}{% set c = 60 %}
  {% elif "nylon" in name %}
    {% set f = "Nylon" %}{% set b = 90 %}{% set e = 260 %}{% set c = 70 %}
  {% elif "pla" in name %}
    {% set f = "PLA" %}{% set b = 60 %}{% set e = 210 %}{% set c = 0 %}
  {% endif %}
  {action_respond_info("Detected filament: %s (from filename) | File: %s | Bed=%d°C Nozzle=%d°C Chamber=%d°C" %
    (f, raw, b, e, c))}

  # (Optional) persist for other macros/UI
  SET_GCODE_VARIABLE MACRO=SET_FILAMENT_TEMP_VARS VARIABLE=filament      VALUE="'{f}'"
  SET_GCODE_VARIABLE MACRO=SET_FILAMENT_TEMP_VARS VARIABLE=bed_temp      VALUE={b}
  SET_GCODE_VARIABLE MACRO=SET_FILAMENT_TEMP_VARS VARIABLE=extruder_temp VALUE={e}
  SET_GCODE_VARIABLE MACRO=SET_FILAMENT_TEMP_VARS VARIABLE=chamber_temp  VALUE={c}
  SET_LED LED="toolhead_light" RED=1 GREEN=1 BLUE=1 WHITE=1 SYNC=0 TRANSMIT=1
  
  # --- Home & QGL ---
  M117 "Homing & QGL"
  G90
  G28
  QUAD_GANTRY_LEVEL
  G28 Z

  # --- Preheat for probing (no extrusion at this temp) ---
  M117 "Preheat for probing"
  M140 S100
  M104 S150
  M190 S100
  M109 S150

  # --- Clean nozzle ---
  M117 "Cleaning nozzle"
  CLEAN_NOZZLE

  # --- Chamber preheat (uses Nevermore/exhaust) ---
  PREHEAT_CHAMBER TARGET={c}

  # --- Adaptive mesh (KAMP) with safe fallback ---
  M117 "Meshing"
  BED_MESH_CLEAR
  {% set eo = printer['exclude_object'] if 'exclude_object' in printer else None %}
  {% if eo and eo.objects|length > 0 %}
    BED_MESH_CALIBRATE ADAPTIVE=1
  {% else %}
    BED_MESH_CALIBRATE
  {% endif %}

  # Turn on auto nevermore fan
  NEVERMORE_AUTO

  # --- Final heating BEFORE any retract/extrude (fixes min_extrude_temp errors) ---
  M117 "Final heating..."
  M140 S{b}
  M104 S{e}
  M190 S{b}
  M109 S{e}

  # --- Now safe for KAMP's park/purge ---
  M117 "Smart Park"
  SMART_PARK
 
  # Purge into the right-side bucket (override X/Z on the call if needed)
  M117 "Purge Bucket"
  PURGE_BUCKET

  # --- Clean nozzle ---
  M117 "Cleaning nozzle"
  CLEAN_NOZZLE
  
  M117 "Printing..."
  G92 E0