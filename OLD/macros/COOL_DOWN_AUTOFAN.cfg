# ==========================================================
# üå¨Ô∏è AUTO COOLDOWN FAN CONTROL
# ==========================================================
[gcode_macro COOL_DOWN_AUTOFAN]
description: "Auto cooldown loop for chamber air handling"
variable_threshold: 40       # ¬∞C: stop fans when chamber <= this
variable_interval: 20        # seconds between checks
variable_running: 0
gcode:
  {% set start = params.START|default(1)|int %}
  {% if start == 1 %}
    SET_GCODE_VARIABLE MACRO=COOL_DOWN_AUTOFAN VARIABLE=running VALUE=1
    {action_respond_info("Auto cooldown started (threshold=%s¬∞C)" % threshold)}
    UPDATE_DELAYED_GCODE ID=_AUTO_AIR_HANDLER DURATION=1
  {% else %}
    SET_GCODE_VARIABLE MACRO=COOL_DOWN_AUTOFAN VARIABLE=running VALUE=0
    UPDATE_DELAYED_GCODE ID=_AUTO_AIR_HANDLER DURATION=0
    SET_FAN_SPEED FAN=nevermore SPEED=0.0
    SET_FAN_SPEED FAN=exhaust_fan SPEED=0.0
    {action_respond_info("Auto cooldown stopped. Fans off.")}
  {% endif %}


[delayed_gcode _AUTO_AIR_HANDLER]
gcode:
  {% set running   = printer["gcode_macro COOL_DOWN_AUTOFAN"].running|int %}
  {% set thr       = printer["gcode_macro COOL_DOWN_AUTOFAN"].threshold|float %}
  {% set interval  = printer["gcode_macro COOL_DOWN_AUTOFAN"].interval|int %}

  {% if running == 0 %}
    UPDATE_DELAYED_GCODE ID=_AUTO_AIR_HANDLER DURATION=0
  {% else %}
    {% set ctemp = printer["temperature_sensor chamber"].temperature|float %}
    {action_respond_info("Chamber %.1f¬∞C (target ‚â§ %.0f¬∞C)" % (ctemp, thr))}
    {% if ctemp <= thr %}
      SET_FAN_SPEED FAN=nevermore SPEED=0.0
      SET_FAN_SPEED FAN=exhaust_fan SPEED=0.0
      SET_GCODE_VARIABLE MACRO=COOL_DOWN_AUTOFAN VARIABLE=running VALUE=0
      {action_respond_info("Cooldown complete. Fans off.")}
      UPDATE_DELAYED_GCODE ID=_AUTO_AIR_HANDLER DURATION=0
    {% else %}
      SET_FAN_SPEED FAN=nevermore SPEED=0.6
      SET_FAN_SPEED FAN=exhaust_fan SPEED=0.6
      UPDATE_DELAYED_GCODE ID=_AUTO_AIR_HANDLER DURATION={interval}
    {% endif %}
  {% endif %}