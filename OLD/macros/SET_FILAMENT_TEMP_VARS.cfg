[gcode_macro SET_FILAMENT_TEMP_VARS]
description: "Set bed/nozzle/chamber based on filename (or FILAMENT= override)"
variable_filament: "PLA"
variable_bed_temp: 60
variable_extruder_temp: 200
variable_chamber_temp: 0

gcode:
  {% set raw  = (printer.print_stats.filename or "") %}
  # normalize common oddities: lowercase, underscores/dashes->space, non-breaking space
  {% set name = raw|lower|replace("\u00a0"," ")|replace("_"," ")|replace("-"," ")|trim %}

  # optional slicer override: START_PRINT FILAMENT=ABS
  {% set fil_param = (params.FILAMENT|default("")|lower) %}

  # choose key (param wins, else find in filename)
  {% set key = '' %}
  {% if fil_param in ['pla','abs','asa','nylon'] %}
    {% set key = fil_param %}
  {% elif 'abs' in name %}
    {% set key = 'abs' %}
  {% elif 'asa' in name %}
    {% set key = 'asa' %}
  {% elif 'nylon' in name %}
    {% set key = 'nylon' %}
  {% elif 'pla' in name %}
    {% set key = 'pla' %}
  {% else %}
    {% set key = 'pla' %}
  {% endif %}

  # assign temps
  {% if key == 'abs' %}
    {% set f='ABS'   %}{% set b=115 %}{% set e=250 %}{% set c=50 %}
  {% elif key == 'asa' %}
    {% set f='ASA'   %}{% set b=115 %}{% set e=255 %}{% set c=50 %}
  {% elif key == 'nylon' %}
    {% set f='Nylon' %}{% set b=90  %}{% set e=260 %}{% set c=70 %}
  {% else %}
    {% set f='PLA'   %}{% set b=60  %}{% set e=210 %}{% set c=0  %}
  {% endif %}

  # info line (what we matched and where it came from)
  {action_respond_info("Detected filament: %s (from %s) | File: %s | Bed=%d°C Nozzle=%d°C Chamber=%d°C" %
    (f, (fil_param if fil_param else 'filename'), raw, b, e, c))}

  # persist (string literal must be quoted)
  SET_GCODE_VARIABLE MACRO=SET_FILAMENT_TEMP_VARS VARIABLE=filament      VALUE="'{f}'"
  SET_GCODE_VARIABLE MACRO=SET_FILAMENT_TEMP_VARS VARIABLE=bed_temp      VALUE={b}
  SET_GCODE_VARIABLE MACRO=SET_FILAMENT_TEMP_VARS VARIABLE=extruder_temp VALUE={e}
  SET_GCODE_VARIABLE MACRO=SET_FILAMENT_TEMP_VARS VARIABLE=chamber_temp  VALUE={c}