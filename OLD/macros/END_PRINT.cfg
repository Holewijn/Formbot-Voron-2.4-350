# ==========================================================
# ðŸ§© END PRINT SEQUENCE (with CLEAN_NOZZLE + anti-ooze retract)
# ==========================================================
[gcode_macro END_PRINT]
description: "Cleanly end the print, wipe nozzle, retract to prevent oozing, and cool down"
variable_retract_len: 2.0      # mm  â† set the retract you want here
variable_retract_speed: 40.0    # mm/s

gcode:
  SAVE_GCODE_STATE NAME=END_PRINT_STATE
  M117 "Finishing up"

  G91
  G1 Z10 F600
  G90
  G0 X340Y350  F6000

  # â€”â€”â€” Final anti-ooze retract (only if we're hot enough to move filament) â€”â€”â€”
  {% set min_temp = printer.configfile.settings.extruder.min_extrude_temp|default(170)|float %}
  {% if printer.extruder.temperature >= min_temp %}
    {% if printer.configfile.settings.firmware_retraction is defined %}
      G10
    {% else %}
      M83
      G1 E-{retract_len} F{(retract_speed*60)|int}    ; e.g. 20 mm @ 40 mm/s
      M82
    {% endif %}
  {% endif %}


  # Turn off heaters & part cooling fan
  M104 S0
  M140 S0
  M107

  # Start automatic cooldown manager
  COOL_DOWN_AUTOFAN START=1
  NEVERMORE_STOP

  M117 "Print complete"
  {action_respond_info(
    "âœ… Print complete. Nozzle cleaned and retracted %.1f mm. Auto-cooldown managing fans until chamber â‰¤ %sÂ°C."
    % (retract_len, printer['gcode_macro COOL_DOWN_AUTOFAN'].threshold)
  )}

  RESTORE_GCODE_STATE NAME=END_PRINT_STATE MOVE=0
