# ==== state holder ====
[gcode_macro _NEVERMORE_STATE]
variable_enabled: 0           # 0=off, 1=on
variable_target: 55.0         # default setpoint (Â°C)
variable_min_speed: 0.10      # start here for a "heating" Nevermore
variable_max_speed: 1.00
variable_kp: 0.08             # PI gains tuned for heating role
variable_ki: 0.003
variable_i: 0.0
variable_last_speed: 0.0
variable_step_max: 0.20
variable_dt: 5.0
gcode:

# ==== main control loop ====
[gcode_macro CHAMBER_FAN_CONTROL]
gcode:
  {% set ns   = printer["gcode_macro _NEVERMORE_STATE"] %}
  {% set en   = ns.variable_enabled|default(0)|int %}
  {% set tgt  = ns.variable_target|default(60.0)|float %}
  {% set smin = ns.variable_min_speed|default(0.30)|float %}
  {% set smax = ns.variable_max_speed|default(1.00)|float %}
  {% set kp   = ns.variable_kp|default(0.08)|float %}
  {% set ki   = ns.variable_ki|default(0.003)|float %}
  {% set iacc = ns.variable_i|default(0.0)|float %}
  {% set last = ns.variable_last_speed|default(0.0)|float %}
  {% set step = ns.variable_step_max|default(0.20)|float %}
  {% set dt   = ns.variable_dt|default(5.0)|float %}

  {% if en == 0 %}
    UPDATE_DELAYED_GCODE ID=nevermore_loop DURATION=0
    SET_GCODE_VARIABLE MACRO=_NEVERMORE_STATE VARIABLE=i VALUE={0.0}
    SET_GCODE_VARIABLE MACRO=_NEVERMORE_STATE VARIABLE=last_speed VALUE={0.0}
    SET_FAN_SPEED FAN=nevermore SPEED=0
  {% else %}
    {% set t = printer["temperature_sensor chamber"].temperature|float %}

    # Inverted (heating) control: positive err when too cold -> speed up
    {% set err = tgt - t %}

    # PI command
    {% set cmd = smin + kp*err + ki*iacc %}

    # If above target by >0.5C allow fan to drop to 0 to avoid overshoot
    {% if t >= tgt + 0.5 and cmd < 0.0 %}
      {% set cmd = 0.0 %}
    {% endif %}

    # Clamp to 0..1, then enforce [smin..smax] when nonzero
    {% if cmd < 0.0 %}{% set cmd = 0.0 %}{% elif cmd > 1.0 %}{% set cmd = 1.0 %}{% endif %}
    {% if cmd > 0.0 %}
      {% if cmd < smin %}{% set cmd = smin %}{% endif %}
      {% if cmd > smax %}{% set cmd = smax %}{% endif %}
    {% endif %}

    # Rate limiting
    {% set delta = cmd - last %}
    {% if delta > step %}
      {% set out = last + step %}
    {% elif delta < -step %}
      {% set out = last - step %}
    {% else %}
      {% set out = cmd %}
    {% endif %}

    # Update integral only when not clamped
    {% set clamped = (cmd <= 0.0 or cmd >= 1.0) %}
    {% if not clamped %}
      {% set i_new = iacc + err*dt %}
    {% else %}
      {% set i_new = iacc %}
    {% endif %}

    SET_FAN_SPEED FAN=nevermore SPEED={ "%.3f"|format(out) }
    SET_GCODE_VARIABLE MACRO=_NEVERMORE_STATE VARIABLE=last_speed VALUE={out}
    SET_GCODE_VARIABLE MACRO=_NEVERMORE_STATE VARIABLE=i VALUE={i_new}
    UPDATE_DELAYED_GCODE ID=nevermore_loop DURATION=5
  {% endif %}


[delayed_gcode nevermore_loop]
initial_duration: 0
gcode:
  CHAMBER_FAN_CONTROL

# ==== enable/disable helpers ====
[gcode_macro NEVERMORE_START]
description: Enable auto Nevermore (S=<target C>)
gcode:
  {% set tgt = params.S|default(60)|float %}
  SET_GCODE_VARIABLE MACRO=_NEVERMORE_STATE VARIABLE=enabled VALUE={1}
  SET_GCODE_VARIABLE MACRO=_NEVERMORE_STATE VARIABLE=target VALUE={tgt}
  SET_GCODE_VARIABLE MACRO=_NEVERMORE_STATE VARIABLE=i VALUE={0.0}
  SET_GCODE_VARIABLE MACRO=_NEVERMORE_STATE VARIABLE=last_speed VALUE={0.0}
  UPDATE_DELAYED_GCODE ID=nevermore_loop DURATION=1
  M118 {"nevermore: enabled, target=" ~ (tgt|string) ~ "C"}

[gcode_macro NEVERMORE_STOP]
description: Disable auto Nevermore
gcode:
  SET_GCODE_VARIABLE MACRO=_NEVERMORE_STATE VARIABLE=enabled VALUE={0}
  UPDATE_DELAYED_GCODE ID=nevermore_loop DURATION=0
  SET_FAN_SPEED FAN=nevermore SPEED=0
  M118 {"nevermore: disabled"}

# ==== optional: pick target from filename ====
[gcode_macro NEVERMORE_AUTO]
gcode:
  {% set file = (printer.print_stats.filename|string)|upper %}
  {% set tgt = 0 %}
  {% if "ABS" in file or "ASA" in file %}
    {% set tgt = 60 %}
  {% elif "PC" in file or "NYLON" in file or " PA" in file %}
    {% set tgt = 65 %}
  {% elif "PETG" in file %}
    {% set tgt = 35 %}
  {% elif "PLA" in file %}
    {% set tgt = 0 %}
  {% endif %}
  M118 {"nevermore: detected " ~ file ~ " -> target=" ~ (tgt|string) ~ "C"}
  NEVERMORE_START S={tgt}
